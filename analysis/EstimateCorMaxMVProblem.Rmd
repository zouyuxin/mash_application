---
title: "mash estimate null correlation problem"
author: "Yuxin Zou"
date: 2018-11-25
output: 
  workflowr::wflow_html:
    code_folding: hide
---

A brief introduction of the algorithm to estimate the null correlation matrix $V$ is in [pdf](Estimate_Null_Cor_Old.pdf). This is the current algorithm we used in `mash`. However, I encountered a problem with one simulated dataset. The log likelihood decreases during the update of parameters.

The simulated data is
$$
\hat{\mathbf{c}}_{j} | \mathbf{c}_{j} \sim N_{10}(\mathbf{c}_{j}, I) \\
\mathbf{c}_{j} = \mu_{j}\mathbf{1}
$$
We subtract the median from each observation, and estimate $V$.

```{r}
library(mashr)
set.seed(1)
data = sim_contrast1(nsamp = 10000, ncond = 10, err_sd = 1)
colnames(data$C) = colnames(data$Chat) = colnames(data$Shat) = 1:10
m.data = mash_set_data(data$Chat, data$Shat)
delta.median = t(apply(data$C, 1, function(x) x - median(x)))
deltahat.median = t(apply(data$Chat, 1, function(x) x - median(x)))

data.median = mash_set_data(deltahat.median, Shat = 1, alpha = 1)
U.c = cov_canonical(data.median)
```

Using the current algorithm, the log likelihood decreases.
```{r}
estV.orig = estimate_null_correlation(data.median, U.c)
plot(estV.orig$loglik)
```

The problem is the EM step to update V.

## One more example

```{r}
source('../code/generateDataV.R')
set.seed(1)
Sigma = cbind(c(1,0.7,0.2), c(0.7,1,0.4), c(0.2,0.4,1))
U0 = matrix(0,3,3)
U1 = matrix(0,3,3); U1[1,1] = 1
U2 = diag(3); U2[3,3] = 0
U3 = matrix(1,3,3)
data = generate_data(n=4000, p=3, V=Sigma, Utrue = list(U0=U0, U1=U1,U2=U2,U3=U3))
```

```{r}
m.data = mash_set_data(data$Bhat, data$Shat)
m.1by1 = mash_1by1(m.data)
strong = get_significant_results(m.1by1)

U.pca = cov_pca(m.data, 3, subset = strong)
U.ed = cov_ed(m.data, U.pca, subset = strong)
U.c = cov_canonical(m.data)
```

```{r}
Vhat = estimate_null_correlation(m.data, c(U.c,U.ed), max_iter = 100, tol=1e-2)
```

```{r}
plot(Vhat$loglik)
```




